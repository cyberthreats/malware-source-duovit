;this util allows you to write in non-writable sections of elf files. it corrects flags in 
;all of programm header's entries to rwx. Use: './elfrwsec <elf-file>'

BITS32
section .text
%include "macros.inc"
global _start
_start:
pop ecx
cmp ecx, 2h; are there wheresep <name> in command line
je n_s
mov eax,4
mov ebx,2
mov ecx,par
mov edx,lp
int 80h
jmp exit;if not prog have to put warning message & exit

n_s
pop ebx
pop ebx;take argv[1]
mov eax,5;sys_open
;for rw ecx=2
mov edx,7777h
int 80h
cmp eax,0;succesful?

jns n_z
mov eax,4
mov ebx,2
mov ecx,cnt
mov edx,lz
int 80h
jmp exit

n_z
mov [fds], eax;save fd if ok
xchg eax, ebx;fd
mov eax,3;sys_read
mov ecx,buf;pbuffer
mov edx,lenght
int 80h;reading the header
mov ebp,esp;stack control point

cmp eax,edx;if can't read > file is too small > it's not ELF
jne est

mov ebx, [ecx]
cmp ebx, 464c457fh;check sign
je ew
est
mov esp,ebp
mov eax,4
mov ebx,2
mov ecx,cn
mov edx,ll
int 80h
jmp exit; if not elf pt message & exit
ew


;push dword [ecx+20h];shoffs
;push dword [ecx+18h];epoint
;push dword [ecx+30h];shnum
null eax
mov ax, word [ecx+2ch]
push eax


mov ecx, [ecx+1ch];phoff
add ecx,18h;flag offs
mov eax,19;seek to 1st sec
mov ebx, [fds];fd
null edx
int 80h

mov edi,eax
pop ecx; counter
lps
push ecx;save count

mov ebx, [fds];fd
mov eax,4;sysread
mov ecx,flags
mov edx,4;size of dword
int 80h

add edi,20h;next

mov ecx,edi
mov eax,19;seek to 1st sec
mov ebx, [fds];fd
null edx
int 80h

pop ecx
dec ecx
jnz lps

mov eax,6
mov ebx,[fds]
int 80h

mov esp,ebp

exit
xchg ebx,eax
one eax
int 80h

section .data
cn db "Error: IT's Not ELF",0ah,0dh
cnt db "Error: Cannot open file",0ah,0dh
par db "Error: Use './elfwrsec file'"
crl db 0ah,0dh
e:
flags dd 7
fds dd 11h
lp equ (e-par)
lz equ (par-cnt)
ll equ (cnt-cn)
lenght equ 34h
section .bss 
buf resb lenght  
